<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Audio Chat</title>
  <style>
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font: 12px sans-serif;
      background: rgba(0, 0, 0, 0.55);
      color: #eee;
      padding: 6px;
      display: flex;
      flex-direction: column;
    }
    h4 {
      margin: 4px 0;
      font-size: 11px;
      color: #ccc;
    }
    #history, #live, #ai {
      font-size: 13px;
      line-height: 1.5;
      margin: 4px 0;
      overflow-y: auto;
      padding: 4px;
      border: 1px solid #666;
      border-radius: 4px;
      background: rgba(0,0,0,0.3);
    }
    #history, #live {
      max-height: 110px;
      overflow-y: auto;
    }

    #ai {
      flex: 1;  /* Fills remaining space */
      overflow-y: auto;
      min-height: 120px;
    }

    #live {
      font-style: italic;
      color: #ffeb3b;
    }
    .entry {
      margin: 2px 0;
    }
    .assistant-entry {
      color: #aed581;
    }
    .controls {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    button {
      padding: 4px 8px;
      font-size: 12px;
      background: #444;
      border: 1px solid #666;
      border-radius: 2px;
      color: #eee;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h4>Transcript History</h4>
  <div id="history"></div>

  <h4>Live Transcript</h4>
  <div id="live">…listening…</div>

  <h4>Assistant</h4>
  <div id="ai"></div>

  <div class="controls">
    <button id="submit-btn">Submit</button>
    <button id="clear-btn">Clear</button>
  </div>

  <script>
    const ipc = window.ipcRenderer;
    const historyEl = document.getElementById("history");
    const liveEl    = document.getElementById("live");
    const aiEl      = document.getElementById("ai");
    const submitBtn = document.getElementById("submit-btn");
    const clearBtn  = document.getElementById("clear-btn");

    let committed   = "";   // everything we accepted as “final”
    let lastPartial = "";   // latest in‑progress phrase

    function render() {
      liveEl.textContent = lastPartial; 
      liveEl.scrollTop   = liveEl.scrollHeight;
    }
    
    function shouldAutoScroll(container) {
      return (container.scrollTop + container.clientHeight >= container.scrollHeight - 5);
    }

    ipc.on("transcript-partial", (text) => {
      lastPartial = text;
      render();
    });

    // assistant replies
    ipc.on("assistant-reply", (msg) => {
      const div = document.createElement("div");
      div.className = "entry assistant-entry";
      div.textContent = msg;
      aiEl.appendChild(div);
    });

    submitBtn.addEventListener("click", () => {
      if (!lastPartial.trim()) return;

      committed  = lastPartial.trim();
      ipc.send("audio-submit", committed);
      lastPartial = "";
      render();
    });

    clearBtn.addEventListener("click", () => {
      historyEl.innerHTML = "";
      committed = "";
      lastPartial = "";
      render();
      aiEl.innerHTML = "";
      ipc.send("audio-clear");
    });

    let liveAssistantDiv = null;
    ipc.on("assistant-stream-start", () => {
      liveAssistantDiv = document.createElement("div");
      liveAssistantDiv.className = "entry assistant-entry";
      aiEl.appendChild(liveAssistantDiv);
    });

    ipc.on("assistant-stream-data", (token) => {
      if (liveAssistantDiv) {
        liveAssistantDiv.textContent += token;
      }
    });

    ipc.on("assistant-stream-end", () => {
      if (liveAssistantDiv) {
        liveAssistantDiv = null;
      }
    });
  </script>
</body>
</html>
